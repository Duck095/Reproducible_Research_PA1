---
editor_options: 
  markdown: 
    wrap: 72
---

# Bài Lab: Các Kiến Thức Cơ Bản trong R

## Giới thiệu

Bài lab này bao gồm các kiến thức cơ bản R dùng để: xử lý biến, vectors,
data frames, ngày tháng, thống kê cơ bản và trực quan hóa dữ liệu.

```{r}
library(tidyverse)
library(lubridate)
library(scales)
```

------------------------------------------------------------------------

## PHẦN 1: BIẾN (VARIABLES) VÀ KIỂU DỮ LIỆU

### 1.1 Tạo và gán biến

```{r}
# Tạo các biến với kiểu dữ liệu khác nhau
### START CODE HERE ### (≈ 4 lines of code)
student_name <- "Tran Trung Duc"    # Character
student_age <- 21                   # Numeric
is_graduated <- FALSE               # Logical
student_grade <- factor("A", levels = c("F","D","C","B","A")) # Factor
### END CODE HERE ###

# Kiểm tra kiểu dữ liệu
class(student_name)
class(student_age)
class(is_graduated)
class(student_grade)
```

### 1.2 Chuyển đổi kiểu dữ liệu

```{r}
# Dữ liệu ban đầu
score_text <- c("85", "92", "78", "88", "95")
pass_numbers <- c(1, 0, 1, 1, 0)

# Chuyển đổi kiểu dữ liệu
### START CODE HERE ### (≈ 2 lines of code)
scores_numeric <- as.numeric(score_text)   # Chuyển từ character sang numeric
pass_logical <- as.logical(pass_numbers)   # Chuyển từ numeric sang logical (0/1 -> FALSE/TRUE)
### END CODE HERE ###

print(scores_numeric)
print(pass_logical)
```

### 1.3 Kiểm tra và xử lý giá trị thiếu

```{r}
# Vector có giá trị NA
test_scores <- c(85, 92, NA, 88, 95, NA, 78)

# Kiểm tra giá trị NA
### START CODE HERE ### (≈ 3 lines of code)
has_na <- any(is.na(test_scores))            # Kiểm tra có NA không
count_na <- sum(is.na(test_scores))          # Đếm số NA
complete_scores <- test_scores[!is.na(test_scores)]   # Loại bỏ NA
### END CODE HERE ###

print(paste("Có NA:", has_na))
print(paste("Số NA:", count_na))
print("Dữ liệu sau khi loại bỏ NA:")
print(complete_scores)
```

------------------------------------------------------------------------

## PHẦN 2: VECTORS (VECTƠ)

### 2.1 Tạo và thao tác với vectors

```{r}
# Tạo vectors
### START CODE HERE ### (≈ 5 lines of code)
numbers <- 1:10                    # Tạo vector từ 1 đến 10
letters_vec <- letters[1:5]        # Tạo vector chứa 5 chữ cái đầu
repeated <- rep(5, 3)              # Lặp số 5 ba lần
sequence <- seq(0, 20, by = 2)     # Tạo dãy từ 0 đến 20, bước nhảy 2
random_nums <- sample(1:100, 10)   # 10 số ngẫu nhiên từ 1 đến 100
### END CODE HERE ###

print(numbers)
print(letters_vec)
print(repeated)
print(sequence)
```

### 2.2 Indexing và Subsetting vectors

```{r}
grades <- c(85, 92, 78, 88, 95, 76, 89, 93, 81, 87)

# Truy xuất phần tử
### START CODE HERE ### (≈ 5 lines of code)
first_grade <- grades[1]                     # Phần tử đầu tiên
last_grade <- grades[length(grades)]         # Phần tử cuối cùng
first_three <- grades[1:3]                   # Ba phần tử đầu
high_grades <- grades[grades >= 85]          # Điểm >= 85
specific_grades <- grades[c(2, 4, 6)]        # Phần tử thứ 2, 4, 6
### END CODE HERE ###

print(paste("Điểm đầu tiên:", first_grade))
print(paste("Ba điểm đầu:", paste(first_three, collapse = ", ")))
print(paste("Điểm cao:", paste(high_grades, collapse = ", ")))
```

### 2.3 Các phép toán với vectors

```{r}
vec1 <- c(10, 20, 30, 40, 50)
vec2 <- c(1, 2, 3, 4, 5)

# Thực hiện các phép toán
### START CODE HERE ### (≈ 4 lines of code)
addition <- vec1 + vec2               # Cộng hai vector
multiplication <- vec1 * vec2         # Nhân hai vector (phần tử tương ứng)
squared <- vec1^2                     # Bình phương vec1
normalized <- vec1 / sum(vec1)        # Chia vec1 cho tổng của nó
### END CODE HERE ###

print("Phép cộng:"); print(addition)
print("Phép nhân:"); print(multiplication)
print("Bình phương:"); print(squared)
print("Chuẩn hóa:"); print(normalized)
```

------------------------------------------------------------------------

## PHẦN 3: DATA FRAMES

### 3.1 Tạo data frame

```{r}
# Tạo data frame về thông tin sinh viên
### START CODE HERE ### (≈ 6-7 lines of code)
students_df <- data.frame(
    student_id = 1:5,
    name = c("An","Binh","Chi","Dung","Em"),
    age = c(20, 21, 22, 20, 23),
    major = c("CS","Math","CS","Economics","CS"),
    gpa = c(3.2, 3.8, 2.9, 3.4, 3.9),
    is_scholarship = c(TRUE, TRUE, FALSE, FALSE, TRUE),
    stringsAsFactors = FALSE
)
### END CODE HERE ###

print(students_df)
str(students_df)
```

### 3.2 Truy xuất dữ liệu từ data frame

```{r}
# Sử dụng data frame vừa tạo
### START CODE HERE ### (≈ 5 lines of code)
first_student <- students_df[1, ]                         # Hàng đầu tiên
names_column <- students_df$name                          # Cột tên
high_gpa <- subset(students_df, gpa > 3.5)                # Sinh viên có GPA > 3.5
cs_students <- subset(students_df, major == "CS")         # Sinh viên ngành CS
top_student <- students_df[which.max(students_df$gpa), ]  # GPA cao nhất
### END CODE HERE ###

print("Sinh viên đầu tiên:")
print(first_student)
print("Sinh viên GPA cao:")
print(high_gpa)
```

### 3.3 Thêm và sửa đổi data frame

```{r}
# Thêm cột mới và sửa đổi dữ liệu
### START CODE HERE ### (≈ 4 lines of code)
students_df$grade_level <- ifelse(students_df$gpa >= 3.5, "Honors", "Regular")
students_df$age[1] <- 21
new_student <- data.frame(student_id=6, name="Lan", age=22, major="Math",
                          gpa=3.6, is_scholarship=FALSE, grade_level="Honors",
                          stringsAsFactors = FALSE)
students_df <- rbind(students_df, new_student)
### END CODE HERE ###

print("Data frame sau khi cập nhật:")
print(students_df)
```

------------------------------------------------------------------------

## PHẦN 4: XỬ LÝ NGÀY THÁNG NĂM

### 4.1 Tạo và chuyển đổi ngày tháng

```{r}
# Tạo các định dạng ngày tháng
### START CODE HERE ### (≈ 5 lines of code)
today_date <- Sys.Date()                      # Ngày hôm nay
birthday <- as.Date("2003-05-15")             # Sinh nhật (ví dụ)
datetime_now <- Sys.time()                    # Ngày giờ hiện tại
custom_date <- as.Date("2024-12-25")          # Tạo ngày từ string "2024-12-25"
formatted_date <- format(today_date, "%d/%m/%Y") # Format ngày theo dd/mm/yyyy
### END CODE HERE ###

print(today_date)
print(birthday)
print(datetime_now)
print(formatted_date)
```

### 4.2 Trích xuất thông tin từ ngày tháng

```{r}
exam_date <- as.Date("2024-06-15")

# Trích xuất các thành phần
### START CODE HERE ### (≈ 5 lines of code)
exam_year <- year(exam_date)                                    # Năm
exam_month <- month(exam_date)                                   # Tháng (số)
exam_day <- day(exam_date)                                       # Ngày
exam_weekday <- wday(exam_date, label = TRUE, abbr = TRUE)       # Thứ trong tuần
days_until_exam <- as.numeric(difftime(exam_date, Sys.Date(), units = "days"))
### END CODE HERE ###

print(paste("Năm thi:", exam_year))
print(paste("Tháng thi:", exam_month))
print(paste("Ngày trong tuần:", exam_weekday))
print(paste("Còn bao nhiêu ngày:", days_until_exam))
```

### 4.3 Tính toán với ngày tháng

```{r}
# Tạo chuỗi thời gian
start_date <- as.Date("2024-01-01")
end_date <- as.Date("2024-12-31")

### START CODE HERE ### (≈ 4 lines of code)
date_sequence <- seq(from = start_date, to = end_date, by = "week")  # mỗi tuần
quarter_dates <- ymd(c("2024-01-01","2024-04-01","2024-07-01","2024-10-01"))
days_in_year <- as.numeric(end_date - start_date) + 1
leap_year <- leap_year(start_date)
### END CODE HERE ###

print("Ngày đầu mỗi tuần (5 ngày đầu):")
print(head(date_sequence, 5))
print("Ngày đầu mỗi quý:")
print(quarter_dates)
```

------------------------------------------------------------------------

## PHẦN 5: THỐNG KÊ CƠ BẢN

### 5.1 Thống kê mô tả

```{r}
# Dữ liệu mẫu
set.seed(123)
student_scores <- rnorm(100, mean = 75, sd = 10)
student_scores <- pmax(0, pmin(100, student_scores))  # Giới hạn 0-100

# Tính các thống kê cơ bản
### START CODE HERE ### (≈ 8 lines of code)
mean_score <- mean(student_scores)               # Điểm trung bình
median_score <- median(student_scores)           # Điểm trung vị
sd_score <- sd(student_scores)                   # Độ lệch chuẩn
min_score <- min(student_scores)                 # Điểm thấp nhất
max_score <- max(student_scores)                 # Điểm cao nhất
q1_score <- quantile(student_scores, 0.25)       # Quartile 1
q3_score <- quantile(student_scores, 0.75)       # Quartile 3
summary_stats <- summary(student_scores)         # Tóm tắt thống kê
### END CODE HERE ###

print(paste("Điểm trung bình:", round(mean_score, 2)))
print(paste("Điểm trung vị:", round(median_score, 2)))
print(paste("Độ lệch chuẩn:", round(sd_score, 2)))
print("Tóm tắt thống kê:")
print(summary_stats)
```

### 5.2 Thống kê theo nhóm

```{r}
# Tạo dữ liệu có nhóm
students_data <- data.frame(
    score = student_scores,
    class = sample(c("A", "B", "C"), 100, replace = TRUE),
    gender = sample(c("Nam", "Nữ"), 100, replace = TRUE)
)

# Thống kê theo lớp
### START CODE HERE ### (≈ 3 lines of code)
class_stats <- students_data %>%
    group_by(class) %>%
    summarise(
        mean_score = mean(score),
        sd_score = sd(score),
        count = n()
    )
### END CODE HERE ###

print("Thống kê theo lớp:")
print(class_stats)

# Thống kê theo giới tính
### START CODE HERE ### (≈ 4 lines of code)
gender_stats <- students_data %>%
    group_by(gender) %>%
    summarise(
        mean_score = mean(score),
        median_score = median(score),
        min_score = min(score),
        max_score = max(score)
    )
### END CODE HERE ###

print("Thống kê theo giới tính:")
print(gender_stats)
```

### 5.3 Correlation và test thống kê

```{r}
# Tạo dữ liệu có tương quan
set.seed(456)
study_hours <- runif(100, 0, 10)
final_scores <- 60 + 3 * study_hours + rnorm(100, 0, 5)
final_scores <- pmax(0, pmin(100, final_scores))

# Tính correlation và test
### START CODE HERE ### (≈ 3 lines of code)
correlation <- cor(study_hours, final_scores)                  # Tương quan giữa giờ học và điểm
t_test_result <- t.test(score ~ gender, data = students_data)  # T-test so sánh điểm nam vs nữ
chi_test <- chisq.test(table(students_data$gender, ifelse(students_data$score >= 75, "Pass", "Fail")))
### END CODE HERE ###

print(paste("Tương quan giờ học - điểm số:", round(correlation, 3)))
print("Kết quả t-test:")
print(t_test_result)
```

------------------------------------------------------------------------

## PHẦN 6: TRỰC QUAN HÓA DỮ LIỆU

### 6.1 Biểu đồ

```{r}
# Dữ liệu cho visualization
sales_data <- data.frame(
    month = month.name[1:12],
    sales = c(120, 135, 148, 162, 178, 195, 210, 205, 188, 175, 158, 142),
    profit = c(12, 15, 18, 22, 28, 32, 35, 33, 28, 25, 20, 16)
)

# Tạo các biểu đồ
### START CODE HERE ### (≈ 4 plots, mỗi plot 1-2 lines)
# Histogram của điểm số
hist(student_scores, main = "Phân bố điểm số", xlab = "Điểm", col = "lightblue")

# Scatter plot giờ học vs điểm
plot(study_hours, final_scores, main = "Giờ học vs Điểm", xlab = "Giờ học", ylab = "Điểm")

# Box plot điểm theo lớp
boxplot(score ~ class, data = students_data, main = "Điểm theo lớp")

# Line plot doanh số theo tháng (dùng chỉ số 1..12 làm trục x)
plot(sales_data$sales, type = "l", main = "Doanh số theo tháng", xlab = "Tháng (1-12)", ylab = "Doanh số")
### END CODE HERE ###
```

### 6.2 Biểu đồ với ggplot2

```{r}
# Bar plot doanh số
### START CODE HERE ### (≈ 4-5 lines of code)
sales_bar <- ggplot(sales_data, aes(x = month, y = sales)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    theme_minimal() +
    labs(title = "Doanh số theo tháng", x = "Tháng", y = "Doanh số") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
### END CODE HERE ###

print(sales_bar)

# Scatter plot với regression line
### START CODE HERE ### (≈ 5-6 lines of code)
study_scatter <- ggplot(data.frame(study_hours, final_scores), 
                       aes(x = study_hours, y = final_scores)) +
    geom_point(alpha = 0.6, color = "blue") +
    geom_smooth(method = "lm", se = TRUE, color = "red") +
    labs(title = "Giờ học và điểm (với đường hồi quy)", x = "Giờ học", y = "Điểm") +
    theme_minimal()
### END CODE HERE ###

print(study_scatter)
```

### 6.3 Biểu đồ nâng cao

```{r}
# Violin plot điểm số theo lớp và giới tính
### START CODE HERE ### (≈ 5-6 lines of code)
violin_plot <- students_data %>%
    ggplot(aes(x = class, y = score, fill = gender)) +
    geom_violin(alpha = 0.7) +
    geom_boxplot(width = 0.2, alpha = 0.5, outlier.shape = NA) +
    facet_wrap(~ gender) +
    labs(title = "Phân bố điểm theo lớp và giới tính", x = "Lớp", y = "Điểm") +
    theme_minimal()
### END CODE HERE ###

print(violin_plot)

# Heatmap correlation matrix
### START CODE HERE ### (≈ 8-10 lines of code)
# Tạo correlation matrix
numeric_data <- students_data %>%
    select(where(is.numeric))

cor_matrix <- round(cor(numeric_data), 2)
cor_df <- as.data.frame(as.table(cor_matrix))  # Var1, Var2, Freq

heatmap_plot <- cor_df %>%
    ggplot(aes(x = Var1, y = Var2, fill = Freq)) +
    geom_tile() +
    scale_fill_gradient2(name = "Correlation", low = "blue", high = "red", mid = "white", midpoint = 0) +
    labs(title = "Ma trận tương quan") +
    theme_minimal()
### END CODE HERE ###

print(heatmap_plot)
```

------------------------------------------------------------------------

## PHẦN 7: BÀI TẬP TỔNG HỢP

### 7.1 Phân tích dữ liệu bán hàng

```{r}
# Tạo dataset bán hàng
set.seed(789)
sales_complex <- data.frame(
    date = seq(as.Date("2023-01-01"), as.Date("2023-12-31"), by = "day"),
    product = sample(c("A", "B", "C", "D"), 365, replace = TRUE),
    sales_amount = abs(rnorm(365, mean = 1000, sd = 200)),
    customer_count = rpois(365, lambda = 15)
)

# Thêm thông tin ngày tháng
### START CODE HERE ### (≈ 5 lines of code)
sales_complex <- sales_complex %>%
    mutate(
        month = month(date, label = TRUE, abbr = TRUE),
        quarter = paste0("Q", quarter(date)),
        weekday = wday(date, label = TRUE, abbr = TRUE),
        is_weekend = weekday %in% c("Sat","Sun"),
        revenue_per_customer = sales_amount / customer_count
    )
### END CODE HERE ###

# Thống kê theo tháng
### START CODE HERE ### (≈ 5-6 lines of code)
monthly_stats <- sales_complex %>%
    group_by(month) %>%
    summarise(
        total_sales = sum(sales_amount),
        avg_sales = mean(sales_amount),
        total_customers = sum(customer_count),
        avg_revenue_per_customer = mean(revenue_per_customer),
        .groups = "drop"
    )
### END CODE HERE ###

print("Thống kê theo tháng:")
print(monthly_stats)
```

### 7.2 Visualization tổng hợp

```{r}
# Tạo dashboard với multiple plots
### START CODE HERE ### (≈ 15-20 lines of code)
library(gridExtra)

# Plot 1: Doanh số theo tháng
p1 <- monthly_stats %>%
    ggplot(aes(x = month, y = total_sales)) +
    geom_line(group = 1, color = "blue", size = 1) +
    geom_point(color = "red", size = 2) +
    labs(title = "Tổng doanh số theo tháng", x = "Tháng", y = "Tổng doanh số") +
    theme_minimal()

# Plot 2: So sánh cuối tuần vs ngày thường
p2 <- sales_complex %>%
    group_by(is_weekend) %>%
    summarise(avg_sales = mean(sales_amount), .groups = "drop") %>%
    ggplot(aes(x = is_weekend, y = avg_sales, fill = is_weekend)) +
    geom_bar(stat = "identity") +
    labs(title = "Doanh số: Cuối tuần vs Ngày thường", x = "Cuối tuần?", y = "Doanh số trung bình") +
    theme_minimal()

# Plot 3: Heatmap doanh số theo sản phẩm và quý
p3 <- sales_complex %>%
    group_by(product, quarter) %>%
    summarise(total_sales = sum(sales_amount), .groups = "drop") %>%
    ggplot(aes(x = quarter, y = product, fill = total_sales)) +
    geom_tile() +
    scale_fill_gradient(low = "white", high = "darkblue") +
    labs(title = "Tổng doanh số theo sản phẩm và quý", x = "Quý", y = "Sản phẩm") +
    theme_minimal()

# Kết hợp các plots
combined_plot <- grid.arrange(p1, p2, p3, ncol = 2)
### END CODE HERE ###
```

### 7.3 Báo cáo thống kê {tự động}

```{r}
# Tạo function để tạo báo cáo thống kê
### START CODE HERE ### (≈ 10-15 lines of code)
create_summary_report <- function(data, numeric_cols, group_col = NULL) {
    # Input: data frame, vector tên cột numeric, tên cột group (optional)
    # Output: summary statistics
    
    if (is.null(group_col)) {
        # Thống kê tổng thể
        summary_stats <- data %>%
            summarise(across(all_of(numeric_cols), list(
                mean = ~mean(.x, na.rm = TRUE),
                median = ~median(.x, na.rm = TRUE),
                sd = ~sd(.x, na.rm = TRUE),
                min = ~min(.x, na.rm = TRUE),
                max = ~max(.x, na.rm = TRUE)
            )))
    } else {
        # Thống kê theo nhóm
        summary_stats <- data %>%
            group_by(across(all_of(group_col))) %>%
            summarise(across(all_of(numeric_cols), list(
                mean = ~mean(.x, na.rm = TRUE),
                median = ~median(.x, na.rm = TRUE),
                sd = ~sd(.x, na.rm = TRUE)
            )), .groups = "drop")
    }
    
    return(summary_stats)
}
### END CODE HERE ###

# Test function
report1 <- create_summary_report(sales_complex, c("sales_amount", "customer_count"))
report2 <- create_summary_report(sales_complex, c("sales_amount"), "product")

print("Báo cáo tổng thể:")
print(report1)
print("Báo cáo theo sản phẩm:")
print(report2)
```

------------------------------------------------------------------------

## KIẾN THỨC HỌC ĐƯỢC

Trong bài lab này, các bạn đã học:

1.  **Biến và kiểu dữ liệu**: Tạo, chuyển đổi và kiểm tra các kiểu dữ
    liệu cơ bản
2.  **Vectors**: Tạo, indexing, và các phép toán với vectors
3.  **Data Frames**: Tạo, truy xuất và thao tác với data frames
4.  **Ngày tháng**: Xử lý và tính toán với dữ liệu thời gian
5.  **Thống kê**: Thống kê mô tả, theo nhóm và các test cơ bản
6.  **Visualization**: Từ biểu đồ cơ bản đến visualization phức tạp với
    ggplot2

**Lưu ý**:

-   Luôn kiểm tra kiểu dữ liệu trước khi thực hiện phép toán
-   Xử lý giá trị thiếu (NA) một cách thích hợp
-   Sử dụng meaningful variable names và comments
-   Kiểm tra và validate kết quả thống kê
-   Chọn loại biểu đồ phù hợp với dữ liệu
